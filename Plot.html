<!DOCTYPE html>
<head>
</head>
<body>
<script src="js/plotly-latest.min.js"></script>
<script src='js/jquery.min.js'></script>

<!-- Plotly chart will be drawn inside this DIV -->
<div id="myDiv0" style="display: none;"></div>
<div id="myDiv1" style="display: none;"></div>
<div id="myDiv2" style="display: none;"></div>
<div id="myDiv3" style="display: none;"></div>
<div id="myDiv4" style="display: none;"></div>
<div id="myDiv5" style="display: none;"></div>
<div id="myDiv6" style="display: none;"></div>
<div id="myDiv7" style="display: none;"></div>
<div id="myDiv8" style="display: none;"></div>
<div id="myDiv9" style="display: none;"></div>
<div id="myDiv10" style="display: none;"></div>
<div id="myDiv11" style="display: none;"></div>
<div id="myDiv12" style="display: none;"></div>
<div id="myDiv13" style="display: none;"></div>
<div id="myDiv14" style="display: none;"></div>
<div id="myDiv15" style="display: none;"></div>
<div id="myDiv16" style="display: none;"></div>
<div id="myDiv17" style="display: none;"></div>
<div id="myDiv18" style="display: none;"></div>
<div id="myDiv19" style="display: none;"></div>
<div id="myDiv20" style="display: none;"></div>
<div id="myDiv21" style="display: none;"></div>
<div id="myDiv22" style="display: none;"></div>
<div id="myDiv23" style="display: none;"></div>
<div id="myDiv24" style="display: none;"></div>
<div id="myDiv25" style="display: none;"></div>
<div id="myDiv26" style="display: none;"></div>
<div id="myDiv27" style="display: none;"></div>
<div id="myDiv28" style="display: none;"></div>
<div id="myDiv29" style="display: none;"></div>
<div id="myDiv30" style="display: none;"></div>
<div id="myDiv31" style="display: none;"></div>
<div id="myDiv32" style="display: none;"></div>
<div id="myDiv33" style="display: none;"></div>
<div id="myDiv34" style="display: none;"></div>
<div id="myDiv35" style="display: none;"></div>
<div id="myDiv36" style="display: none;"></div>
<div id="myDiv37" style="display: none;"></div>
<div id="myDiv38" style="display: none;"></div>
<div id="myDiv39" style="display: none;"></div>
<div id="myDiv40" style="display: none;"></div>
<div id="myDiv41" style="display: none;"></div>
<div id="myDiv42" style="display: none;"></div>
<div id="myDiv43" style="display: none;"></div>
<div id="myDiv44" style="display: none;"></div>
<div id="myDiv45" style="display: none;"></div>
<div id="myDiv46" style="display: none;"></div>
<div id="myDiv47" style="display: none;"></div>
<div id="myDiv48" style="display: none;"></div>
<div id="myDiv49" style="display: none;"></div>
<div id="myDiv50" style="display: none;"></div>
<div id="myDiv51" style="display: none;"></div>
<div id="myDiv52" style="display: none;"></div>
<div id="myDiv53" style="display: none;"></div>
<div id="myDiv54" style="display: none;"></div>
<div id="myDiv55" style="display: none;"></div>
<div id="myDiv56" style="display: none;"></div>
<div id="myDiv57" style="display: none;"></div>
<div id="myDiv58" style="display: none;"></div>
<div id="myDiv59" style="display: none;"></div>
<div id="myDiv60" style="display: none;"></div>
<div id="myDiv61" style="display: none;"></div>
<div id="myDiv62" style="display: none;"></div>
<div id="myDiv63" style="display: none;"></div>
<div id="myDiv64" style="display: none;"></div>
<div id="myDiv65" style="display: none;"></div>
<div id="myDiv66" style="display: none;"></div>
<div id="myDiv67" style="display: none;"></div>
<div id="myDiv68" style="display: none;"></div>
<div id="myDiv69" style="display: none;"></div>
<div id="myDiv70" style="display: none;"></div>
<div id="myDiv71" style="display: none;"></div>
<div id="myDiv72" style="display: none;"></div>
<div id="myDiv73" style="display: none;"></div>
<div id="myDiv74" style="display: none;"></div>
<div id="myDiv75" style="display: none;"></div>
<div id="myDiv76" style="display: none;"></div>
<div id="myDiv77" style="display: none;"></div>
<div id="myDiv78" style="display: none;"></div>
<div id="myDiv79" style="display: none;"></div>
<div id="myDiv80" style="display: none;"></div>
<div id="myDiv81" style="display: none;"></div>
<div id="myDiv82" style="display: none;"></div>
<div id="myDiv83" style="display: none;"></div>
<div id="myDiv84" style="display: none;"></div>
<div id="myDiv85" style="display: none;"></div>
<div id="myDiv86" style="display: none;"></div>
<div id="myDiv87" style="display: none;"></div>
<div id="myDiv88" style="display: none;"></div>
<div id="myDiv89" style="display: none;"></div>
<div id="myDiv90" style="display: none;"></div>
<div id="myDiv91" style="display: none;"></div>
<div id="myDiv92" style="display: none;"></div>
<div id="myDiv93" style="display: none;"></div>
<div id="myDiv94" style="display: none;"></div>
<div id="myDiv95" style="display: none;"></div>
<div id="myDiv96" style="display: none;"></div>
<div id="myDiv97" style="display: none;"></div>
<div id="myDiv98" style="display: none;"></div>
<div id="myDiv99" style="display: none;"></div>

<img id="png-export0"></img>
<img id="png-export1"></img>
<img id="png-export2"></img>
<img id="png-export3"></img>
<img id="png-export4"></img>
<img id="png-export5"></img>
<img id="png-export6"></img>
<img id="png-export7"></img>
<img id="png-export8"></img>
<img id="png-export9"></img>
<img id="png-export10"></img>
<img id="png-export11"></img>
<img id="png-export12"></img>
<img id="png-export13"></img>
<img id="png-export14"></img>
<img id="png-export15"></img>
<img id="png-export16"></img>
<img id="png-export17"></img>
<img id="png-export18"></img>
<img id="png-export19"></img>
<img id="png-export20"></img>
<img id="png-export21"></img>
<img id="png-export22"></img>
<img id="png-export23"></img>
<img id="png-export24"></img>
<img id="png-export25"></img>
<img id="png-export26"></img>
<img id="png-export27"></img>
<img id="png-export28"></img>
<img id="png-export29"></img>
<img id="png-export30"></img>
<img id="png-export31"></img>
<img id="png-export32"></img>
<img id="png-export33"></img>
<img id="png-export34"></img>
<img id="png-export35"></img>
<img id="png-export36"></img>
<img id="png-export37"></img>
<img id="png-export38"></img>
<img id="png-export39"></img>
<img id="png-export40"></img>
<img id="png-export41"></img>
<img id="png-export42"></img>
<img id="png-export43"></img>
<img id="png-export44"></img>
<img id="png-export45"></img>
<img id="png-export46"></img>
<img id="png-export47"></img>
<img id="png-export48"></img>
<img id="png-export49"></img>
<img id="png-export50"></img>
<img id="png-export51"></img>
<img id="png-export52"></img>
<img id="png-export53"></img>
<img id="png-export54"></img>
<img id="png-export55"></img>
<img id="png-export56"></img>
<img id="png-export57"></img>
<img id="png-export58"></img>
<img id="png-export59"></img>
<img id="png-export60"></img>
<img id="png-export61"></img>
<img id="png-export62"></img>
<img id="png-export63"></img>
<img id="png-export64"></img>
<img id="png-export65"></img>
<img id="png-export66"></img>
<img id="png-export67"></img>
<img id="png-export68"></img>
<img id="png-export69"></img>
<img id="png-export70"></img>
<img id="png-export71"></img>
<img id="png-export72"></img>
<img id="png-export73"></img>
<img id="png-export74"></img>
<img id="png-export75"></img>
<img id="png-export76"></img>
<img id="png-export77"></img>
<img id="png-export78"></img>
<img id="png-export79"></img>
<img id="png-export80"></img>
<img id="png-export81"></img>
<img id="png-export82"></img>
<img id="png-export83"></img>
<img id="png-export84"></img>
<img id="png-export85"></img>
<img id="png-export86"></img>
<img id="png-export87"></img>
<img id="png-export88"></img>
<img id="png-export89"></img>
<img id="png-export90"></img>
<img id="png-export91"></img>
<img id="png-export92"></img>
<img id="png-export93"></img>
<img id="png-export94"></img>
<img id="png-export95"></img>
<img id="png-export96"></img>
<img id="png-export97"></img>
<img id="png-export98"></img>
<img id="png-export99"></img>

<script>
	var millArray = ["集團", "東莞", "廣東", "江蘇", "江西", "重慶" ];
	var categoryArray = ["輔料(含化學品）", "澱粉", "輥、網布及毛布", "馬達/電機", "電器零件", "閥門類", "軸承類", "大五金(其他)", "小五金(其他)", "廠車配件(叉車,抱車,夾車)", "建築材料", "儀表類", "電腦設備", "文儀用品", "食材", "後勤" ];
	var d3 = Plotly.d3;

	$(document).ready(function() {
		$.ajax({
			type: "GET",
			url: "https://raw.githubusercontent.com/kenneth-mk-chu/CatPlot/master/BaseData.csv",
			dataType: "text",
			success: function(data) { processData(data); }
		 });
	});

	function processData(data) {
		var allTextLines = data.split(/\r\n|\n/);
		var lines = [];
		
		for (var line = 0; line < allTextLines.length; line++) {
			var entries = allTextLines[line].split(',');
			lines.push(entries);
		}
		processArrayData(lines);
	}

	//function makeplot() {
	//	Plotly.d3.csv("https://raw.githubusercontent.com/kenneth-mk-chu/CatPlot/master/BaseData.csv", function(data){ processData(data) } );
	//};
    
	function processArrayData(allRows) {
		console.log(allRows);
	
		var catMatrix = [];
		rowCnt = 0;
		cnt = 0;
		for (var mill = 0; mill < millArray.length; mill++) {
			millName = millArray[mill];		
			
			for (var cat = 0; cat < 16; cat++) { 
				row = allRows[rowCnt];

				monthX = [];
				exY = [];
				imY = [];
				maxY = 0;
				
				for (var month = 1; month <= (row.length / 2); month++) {
					monthX.push(month);
					exY.push(row[2 * month - 1]);
					imY.push(row[2 * month - 2]);
					
					if (Number(row[2 * month - 1]) > maxY) {
						maxY = Number(row[2 * month - 1]);
					}
					if (Number(row[2 * month - 2]) > maxY) {
						maxY = Number(row[2 * month - 2]);
					}
				}
				
				catMatrix[cnt] = {
					x: Array.from(monthX),
					y1: Array.from(exY),
					y2: Array.from(imY),
					maxY: Math.pow(10, Math.ceil(Math.log10(maxY))),
					title: millName + " - " + categoryArray[cat]
				};
				makePlotly(catMatrix[cnt], cnt);
				cnt++;
				rowCnt++;
			}
		}
		console.log(catMatrix);
		
	}

	function makePlotly(catStructure, idx) {
		var img_png= d3.select('#png-export' + idx);
		
		var traceIm = {
			x: catStructure.x, 
			y: catStructure.y2,
			type: 'bar',
			marker: {
				opacity: 0.6,
				line: {
				  width: 1,
				},
			  },
			name: "入倉" 
		};
		var traceEx = {
			x: catStructure.x, 
			y: catStructure.y1,
			type: 'bar',
			marker: {
				opacity: 0.6,
				line: {
				  width: 1,
				},
			  },
			name: "出倉"
		};

		var data = [traceIm, traceEx];
		
		var layout = {
		  barmode: 'group',
		  bargap: 0.5,
		  bargroupgap: 0.0,
		  title: {
			text: '<b>' + catStructure.title + '</b>',
			font: {
			  family: '楷体, STKaiti, 华文楷体, serif',
			  size: 36,
			},
		  },
		  xaxis: {
			title: {
			  text: '<b>月份</b>',
			  font: {
			    family: '楷体, STKaiti, 华文楷体, serif',
			    size: 28,
			  },
			},
			gridcolor: '#999999',
			gridwidth: 1,	
			dtick: 1,
			tickvals: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
			tickfont: {
			  family: '楷体, STKaiti, 华文楷体, serif',
			  size: 28,
			},
			range: [0, 12],
			linecolor: 'black',
			linewidth: 2,
			mirror: true,
		  },
		  yaxis: {
			title: {
			  text: '<b>人民幣</b>',
			  font: {
			    family: '楷体, STKaiti, 华文楷体, serif',
			    size: 28,
			  },
			},
			gridcolor: '#999999',
			gridwidth: 1,	
			dtick: catStructure.maxY / 10,
			range: [0, catStructure.maxY],
			tickfont: {
			  family: '楷体, STKaiti, 华文楷体, serif',
			  size: 28,
			},
			linecolor: 'black',
			linewidth: 2,
			mirror: true,			
		  },
		  legend: {
			traceorder: 'normal',
			font: {
			  family: '楷体, STKaiti, 华文楷体, serif',
			  size: 28,
			},
			bordercolor: 'black',
			borderwidth: 2,		
			//orientation: 'h',
			//xanchor: 'right',
			//x: 1,
			//y: 1,
		  },
		};
		
		Plotly.newPlot('myDiv' + idx, data, layout)
		.then(
		function(gd)
			{
				Plotly.toImage(gd,{height:800,width:2400})
				.then(
					function(url)
				{
					img_png.attr("src", url);
				}
			)
		});
	};
	
</script>
</body>
</html>