<!DOCTYPE html>
<head>
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src='https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js'></script>
</head>
<body>
<!-- Plotly chart will be drawn inside this DIV -->
<div id="myDiv1"></div>
<div id="myDiv2"></div>
<div id="myDiv3"></div>
<div id="myDiv4"></div>
<div id="myDiv5"></div>
<div id="myDiv6"></div>
<div id="myDiv7"></div>
<div id="myDiv8"></div>
<div id="myDiv9"></div>
<div id="myDiv10"></div>
<div id="myDiv11"></div>
<div id="myDiv12"></div>
<div id="myDiv13"></div>
<div id="myDiv14"></div>
<div id="myDiv15"></div>
<div id="myDiv16"></div>
<div id="myDiv17"></div>
<script>
	var millArray = ["東莞", "廣東", "江蘇", "江西", "重慶" ];
	var categoryArray = ["輔料(含化學品）", "澱粉", "輥、網布及毛布", "馬達/電機", "電器零件", "閥門類", "軸承類", "大五金(其他)", "小五金(其他)", "廠車配件(叉車,抱車,夾車)", "建築材料", "儀表類", "電腦設備", "文儀用品", "食材", "後勤" ];

	$(document).ready(function() {
		$.ajax({
			type: "GET",
			url: "https://raw.githubusercontent.com/kenneth-mk-chu/CatPlot/master/BaseData.csv",
			dataType: "text",
			success: function(data) { processData(data); }
		 });
	});

	function processData(data) {
		var allTextLines = data.split(/\r\n|\n/);
		var lines = [];
		
		for (var line = 0; line < allTextLines.length; line++) {
			var entries = allTextLines[line].split(',');
			lines.push(entries);
		}
		processArrayData(lines);
	}

	//function makeplot() {
	//	Plotly.d3.csv("https://raw.githubusercontent.com/kenneth-mk-chu/CatPlot/master/BaseData.csv", function(data){ processData(data) } );
	//};
    
	function processArrayData(allRows) {
		console.log(allRows);
	
		var catMatrix = [];
		rowCnt = 0;
		for (var mill = 0; mill < millArray.length; mill++) {
			millName = millArray[mill];		
			
			for (var cat = 0; cat < 16; cat++) { 
				row = allRows[rowCnt];

				monthX = [];
				exY = [];
				imY = [];
				
				for (var month = 1; month <= (row.length / 2); month++) {
					monthX.push(month);
					exY.push(row[2 * month - 1]);
					imY.push(row[2 * month - 2]);
				}
				catMatrix[cat] = {
					x: Array.from(monthX),
					y1: Array.from(exY),
					y2: Array.from(imY),
					title: millName + " - " + categoryArray[cat]
				};
				makePlotly(catMatrix[cat], cat + 1);
				rowCnt++;
			}
		}
		
	}

	function makePlotly(catStructure, idx) {
		var traceIm = {
			x: catStructure.x, 
			y: catStructure.y2,
			name: "入倉" 
		};
		var traceEx = {
			x: catStructure.x, 
			y: catStructure.y1,
			name: "出倉"
		};

		var data = [traceIm, traceEx];
		
		var layout = {
		  title: {
			text: catStructure.title,
			font: {
			  size: 24
			},
		  },
		  xaxis: {
			title: {
			  text: '月份',
			},
		  },
		  yaxis: {
			title: {
			  text: '人民幣',
			}
		  }
		};

		Plotly.newPlot('myDiv' + idx, data, layout);
	};
</script>